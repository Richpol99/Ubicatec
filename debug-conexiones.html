<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Conexiones del Grafo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Conexiones del Grafo</h1>
        <p>Verificar que las conexiones secuenciales se est√©n creando correctamente</p>
        
        <div class="section">
            <h3>Controles</h3>
            <button class="btn" onclick="initGraph()">Inicializar Grafo</button>
            <button class="btn" onclick="checkSequentialConnections()">Verificar Conexiones Secuenciales</button>
            <button class="btn" onclick="checkRoutePath()">Verificar Ruta 2‚Üí36</button>
            <button class="btn" onclick="clearLog()">Limpiar Log</button>
        </div>
        
        <div class="section">
            <h3>Log de Debug</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script src="js/campus-graph.js"></script>
    <script src="js/route-calculator.js"></script>

    <script>
        let grafo;
        let routeCalculator;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : 
                            type === 'success' ? 'success' : 
                            type === 'warning' ? 'warning' : 'info';
            
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function initGraph() {
            clearLog();
            log('üöÄ Inicializando grafo...', 'info');
            
            try {
                grafo = new CampusGraph();
                const stats = grafo.getStatistics();
                log(`‚úÖ Grafo inicializado: ${stats.totalNodes} nodos, ${stats.totalConnections} conexiones`, 'success');
                log(`üìä Nodos por tipo: ${JSON.stringify(stats.nodesByType)}`, 'info');
                
                routeCalculator = new RouteCalculator(grafo);
                log('‚úÖ Calculador de rutas inicializado', 'success');
                
            } catch (error) {
                log(`‚ùå Error inicializando grafo: ${error.message}`, 'error');
            }
        }

        function checkSequentialConnections() {
            if (!grafo) {
                log('‚ùå Grafo no inicializado', 'error');
                return;
            }

            log('üîç Verificando conexiones secuenciales...', 'info');
            
            // Verificar ruta naranja
            log('üü† Verificando ruta NARANJA:', 'info');
            let naranjaConnections = 0;
            let naranjaMissing = [];
            
            for (let i = 1; i <= 40; i++) {
                const from = `naranja_${i}`;
                const to = `naranja_${i + 1}`;
                
                if (grafo.nodes.has(from) && grafo.nodes.has(to)) {
                    const connections = grafo.getConnectionsFrom(from);
                    const hasConnection = connections.some(conn => conn.to === to);
                    
                    if (hasConnection) {
                        naranjaConnections++;
                        log(`‚úÖ ${from} ‚Üí ${to}`, 'success');
                    } else {
                        naranjaMissing.push(`${from} ‚Üí ${to}`);
                        log(`‚ùå FALTA: ${from} ‚Üí ${to}`, 'error');
                    }
                }
            }
            
            log(`üìä Ruta naranja: ${naranjaConnections} conexiones encontradas`, 'info');
            if (naranjaMissing.length > 0) {
                log(`‚ö†Ô∏è Conexiones faltantes: ${naranjaMissing.length}`, 'warning');
            }
            
            // Verificar ruta azul
            log('üîµ Verificando ruta AZUL:', 'info');
            let azulConnections = 0;
            let azulMissing = [];
            
            for (let i = 1; i <= 19; i++) {
                const from = `azul_${i}`;
                const to = `azul_${i + 1}`;
                
                if (grafo.nodes.has(from) && grafo.nodes.has(to)) {
                    const connections = grafo.getConnectionsFrom(from);
                    const hasConnection = connections.some(conn => conn.to === to);
                    
                    if (hasConnection) {
                        azulConnections++;
                        log(`‚úÖ ${from} ‚Üí ${to}`, 'success');
                    } else {
                        azulMissing.push(`${from} ‚Üí ${to}`);
                        log(`‚ùå FALTA: ${from} ‚Üí ${to}`, 'error');
                    }
                }
            }
            
            log(`üìä Ruta azul: ${azulConnections} conexiones encontradas`, 'info');
            if (azulMissing.length > 0) {
                log(`‚ö†Ô∏è Conexiones faltantes: ${azulMissing.length}`, 'warning');
            }
        }

        function checkRoutePath() {
            if (!routeCalculator) {
                log('‚ùå Calculador de rutas no inicializado', 'error');
                return;
            }

            log('üõ£Ô∏è Calculando ruta del Edificio 2 al 36...', 'info');
            
            try {
                const route = routeCalculator.calculateRoute('edif_2', 'edif_36', 'mobility');
                
                log(`‚úÖ Ruta calculada: ${route.path.length} nodos`, 'success');
                log(`üìè Distancia total: ${route.totalDistance.toFixed(1)}m`, 'info');
                log(`‚è±Ô∏è Tiempo estimado: ${route.estimatedTime.toFixed(1)}min`, 'info');
                
                log('üõ§Ô∏è Ruta completa:', 'info');
                route.path.forEach((nodeId, index) => {
                    const node = grafo.getNode(nodeId);
                    const routeType = node?.metadata?.route || 'edificio';
                    log(`  ${index + 1}. ${nodeId} (${routeType})`, 'info');
                });
                
                // Verificar si hay saltos en la secuencia
                log('üîç Verificando saltos en la secuencia...', 'info');
                let hasJumps = false;
                
                for (let i = 0; i < route.path.length - 1; i++) {
                    const current = route.path[i];
                    const next = route.path[i + 1];
                    
                    // Si ambos son de la misma ruta, verificar si son consecutivos
                    const currentNode = grafo.getNode(current);
                    const nextNode = grafo.getNode(next);
                    
                    if (currentNode?.metadata?.route && nextNode?.metadata?.route && 
                        currentNode.metadata.route === nextNode.metadata.route) {
                        
                        const currentIndex = currentNode.metadata.index;
                        const nextIndex = nextNode.metadata.index;
                        const diff = Math.abs(nextIndex - currentIndex);
                        
                        if (diff > 1) {
                            hasJumps = true;
                            log(`‚ö†Ô∏è SALTO DETECTADO: ${current} (√≠ndice ${currentIndex}) ‚Üí ${next} (√≠ndice ${nextIndex}) - Diferencia: ${diff}`, 'warning');
                        }
                    }
                }
                
                if (!hasJumps) {
                    log('‚úÖ No se detectaron saltos en la secuencia', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Error calculando ruta: ${error.message}`, 'error');
            }
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ P√°gina cargada, listo para debuggear', 'info');
        });
    </script>
</body>
</html>
