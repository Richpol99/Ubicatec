<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Base de Datos de Nodos del Campus</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #map { height: 400px; width: 100%; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0; }
        .stat-card { background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center; }
        .node-list { max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; }
        .node-item { padding: 5px; border-bottom: 1px solid #ddd; font-size: 12px; }
        .node-type { font-weight: bold; color: #007bff; }
        .node-coords { color: #6c757d; font-size: 10px; }
    </style>
</head>
<body>
    <h1>üß™ Test del PASO 2 - Base de Datos de Nodos del Campus</h1>
    
    <div class="test-section info">
        <h3>üìã Informaci√≥n del Test</h3>
        <p>Este test verifica que el PASO 2 (CampusNodes) funcione correctamente.</p>
        <p><strong>Archivo creado:</strong> js/campus-nodes.js</p>
        <p><strong>Funcionalidades:</strong> Base de datos de nodos, generaci√≥n autom√°tica de intersecciones y waypoints</p>
    </div>

    <div class="test-section">
        <h3>üó∫Ô∏è Mapa de Nodos</h3>
        <p>Mapa mostrando todos los nodos generados:</p>
        <div id="map"></div>
    </div>

    <div class="test-section">
        <h3>üîß Controles de Prueba</h3>
        <button onclick="testInitialization()">1. Probar Inicializaci√≥n</button>
        <button onclick="testStatistics()">2. Ver Estad√≠sticas</button>
        <button onclick="testNodeSearch()">3. Probar B√∫squeda</button>
        <button onclick="testNodeTypes()">4. Ver Tipos de Nodos</button>
        <button onclick="testAccessibility()">5. Ver Accesibilidad</button>
        <button onclick="testNearestNode()">6. Probar Nodo M√°s Cercano</button>
        <button onclick="testAddNode()">7. Agregar Nodo de Prueba</button>
        <button onclick="clearLog()">üßπ Limpiar Log</button>
    </div>

    <div class="test-section">
        <h3>üìä Estad√≠sticas de Nodos</h3>
        <div id="stats" class="stats"></div>
    </div>

    <div class="test-section">
        <h3>üìù Log de Resultados</h3>
        <div id="log" class="log">Esperando pruebas...<br></div>
    </div>

    <div class="test-section">
        <h3>üìã Lista de Nodos</h3>
        <div id="nodeList" class="node-list">Cargando nodos...</div>
    </div>

    <!-- Dependencias necesarias -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- Nuestro sistema de nodos del campus -->
    <script src="js/campus-nodes.js"></script>

    <script>
        let map;
        let campusNodes;
        let nodeMarkers = [];

        // Inicializar mapa de prueba
        function initTestMap() {
            map = L.map('map').setView([19.0698, -98.1688], 18);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            log('‚úÖ Mapa de prueba inicializado');
        }

        // Funci√≥n de logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'Log limpiado...<br>';
        }

        // Test 1: Inicializaci√≥n
        function testInitialization() {
            log('üß™ Iniciando test de inicializaci√≥n...');
            
            try {
                if (typeof CampusNodes === 'undefined') {
                    throw new Error('Clase CampusNodes no encontrada');
                }
                
                log('‚úÖ Clase CampusNodes encontrada');
                
                campusNodes = new CampusNodes();
                log('‚úÖ Instancia de CampusNodes creada');
                
                const stats = campusNodes.getStatistics();
                log(`üìä Nodos cargados: ${stats.total}`);
                
                // Mostrar estad√≠sticas
                displayStatistics(stats);
                
                // Mostrar nodos en el mapa
                displayNodesOnMap();
                
                // Mostrar lista de nodos
                displayNodeList();
                
                log('‚úÖ Test de inicializaci√≥n completado', 'success');
                
            } catch (error) {
                log(`‚ùå Error en inicializaci√≥n: ${error.message}`, 'error');
            }
        }

        // Test 2: Estad√≠sticas
        function testStatistics() {
            log('üß™ Verificando estad√≠sticas...');
            
            if (!campusNodes) {
                log('‚ùå CampusNodes no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            const stats = campusNodes.getStatistics();
            log(`üìä Estad√≠sticas del sistema:`);
            log(`   - Total de nodos: ${stats.total}`);
            log(`   - Por tipo: ${JSON.stringify(stats.byType)}`);
            log(`   - Accesibilidad: ${JSON.stringify(stats.byAccessibility)}`);
            
            displayStatistics(stats);
            log('‚úÖ Estad√≠sticas verificadas', 'success');
        }

        // Test 3: B√∫squeda de nodos
        function testNodeSearch() {
            log('üß™ Probando b√∫squeda de nodos...');
            
            if (!campusNodes) {
                log('‚ùå CampusNodes no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            // Buscar por nombre
            const searchResults = campusNodes.findNodesByName('Edificio 15');
            log(`üîç B√∫squeda por nombre "Edificio 15": ${searchResults.length} resultados`);
            searchResults.forEach(node => {
                log(`   - ${node.name} (${node.type})`);
            });

            // Buscar por tipo
            const buildings = campusNodes.findNodesByType('building');
            log(`üè¢ Nodos de tipo "building": ${buildings.length}`);

            const intersections = campusNodes.findNodesByType('intersection');
            log(`üîÑ Nodos de tipo "intersection": ${intersections.length}`);

            log('‚úÖ B√∫squeda de nodos funcionando', 'success');
        }

        // Test 4: Tipos de nodos
        function testNodeTypes() {
            log('üß™ Verificando tipos de nodos...');
            
            if (!campusNodes) {
                log('‚ùå CampusNodes no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            const allNodes = campusNodes.exportNodes();
            const typeCounts = {};
            
            allNodes.forEach(node => {
                typeCounts[node.type] = (typeCounts[node.type] || 0) + 1;
            });

            log(`üìã Tipos de nodos encontrados:`);
            Object.entries(typeCounts).forEach(([type, count]) => {
                log(`   - ${type}: ${count} nodos`);
            });

            log('‚úÖ Tipos de nodos verificados', 'success');
        }

        // Test 5: Accesibilidad
        function testAccessibility() {
            log('üß™ Verificando accesibilidad...');
            
            if (!campusNodes) {
                log('‚ùå CampusNodes no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            const allNodes = campusNodes.exportNodes();
            let wheelchairAccessible = 0;
            let visualAccessible = 0;
            let auditoryAccessible = 0;
            let mobilityAccessible = 0;

            allNodes.forEach(node => {
                if (node.accessibility.wheelchair) wheelchairAccessible++;
                if (node.accessibility.visual) visualAccessible++;
                if (node.accessibility.auditory) auditoryAccessible++;
                if (node.accessibility.mobility) mobilityAccessible++;
            });

            log(`‚ôø Accesibilidad de nodos:`);
            log(`   - Silla de ruedas: ${wheelchairAccessible}/${allNodes.length}`);
            log(`   - Visual: ${visualAccessible}/${allNodes.length}`);
            log(`   - Auditiva: ${auditoryAccessible}/${allNodes.length}`);
            log(`   - Movilidad: ${mobilityAccessible}/${allNodes.length}`);

            log('‚úÖ Accesibilidad verificada', 'success');
        }

        // Test 6: Nodo m√°s cercano
        function testNearestNode() {
            log('üß™ Probando b√∫squeda de nodo m√°s cercano...');
            
            if (!campusNodes) {
                log('‚ùå CampusNodes no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            // Coordenadas de prueba (centro del campus)
            const testCoords = [19.0698, -98.1688];
            const nearest = campusNodes.findNearestNode(testCoords);
            
            if (nearest) {
                const distance = campusNodes.calculateDistance(testCoords, nearest.coords);
                log(`üìç Nodo m√°s cercano a [${testCoords[0]}, ${testCoords[1]}]:`);
                log(`   - Nombre: ${nearest.name}`);
                log(`   - Tipo: ${nearest.type}`);
                log(`   - Distancia: ${Math.round(distance)} metros`);
            } else {
                log('‚ùå No se encontr√≥ nodo cercano');
            }

            log('‚úÖ B√∫squeda de nodo m√°s cercano funcionando', 'success');
        }

        // Test 7: Agregar nodo
        function testAddNode() {
            log('üß™ Probando agregar nodo...');
            
            if (!campusNodes) {
                log('‚ùå CampusNodes no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            const newNodeData = {
                type: 'ramp',
                name: 'Rampa de Prueba',
                coords: [19.0698, -98.1688],
                accessibility: {
                    wheelchair: true,
                    visual: true,
                    auditory: true,
                    mobility: true
                },
                metadata: {
                    test: true,
                    description: 'Nodo de prueba agregado din√°micamente'
                }
            };

            const nodeId = campusNodes.addNode(newNodeData);
            log(`‚úÖ Nodo agregado con ID: ${nodeId}`);

            // Actualizar visualizaciones
            displayStatistics(campusNodes.getStatistics());
            displayNodesOnMap();
            displayNodeList();

            log('‚úÖ Agregar nodo funcionando', 'success');
        }

        // Mostrar estad√≠sticas
        function displayStatistics(stats) {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <h4>Total</h4>
                    <p>${stats.total}</p>
                </div>
                <div class="stat-card">
                    <h4>Edificios</h4>
                    <p>${stats.byType.building || 0}</p>
                </div>
                <div class="stat-card">
                    <h4>Intersecciones</h4>
                    <p>${stats.byType.intersection || 0}</p>
                </div>
                <div class="stat-card">
                    <h4>Waypoints</h4>
                    <p>${stats.byType.waypoint || 0}</p>
                </div>
                <div class="stat-card">
                    <h4>Accesos</h4>
                    <p>${stats.byType.access_point || 0}</p>
                </div>
                <div class="stat-card">
                    <h4>Silla de Ruedas</h4>
                    <p>${stats.byAccessibility.wheelchair}</p>
                </div>
            `;
        }

        // Mostrar nodos en el mapa
        function displayNodesOnMap() {
            if (!campusNodes) return;

            // Limpiar marcadores existentes
            nodeMarkers.forEach(marker => map.removeLayer(marker));
            nodeMarkers = [];

            const allNodes = campusNodes.exportNodes();
            const typeColors = {
                building: 'blue',
                intersection: 'green',
                waypoint: 'orange',
                access_point: 'red',
                ramp: 'purple',
                elevator: 'brown',
                stairs: 'gray'
            };

            allNodes.forEach(node => {
                const color = typeColors[node.type] || 'black';
                const marker = L.circleMarker(node.coords, {
                    radius: 5,
                    fillColor: color,
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindPopup(`
                    <strong>${node.name}</strong><br>
                    Tipo: ${node.type}<br>
                    Coordenadas: [${node.coords[0].toFixed(6)}, ${node.coords[1].toFixed(6)}]<br>
                    Silla de ruedas: ${node.accessibility.wheelchair ? '‚úÖ' : '‚ùå'}
                `);

                nodeMarkers.push(marker);
            });

            log(`üó∫Ô∏è ${allNodes.length} nodos mostrados en el mapa`);
        }

        // Mostrar lista de nodos
        function displayNodeList() {
            if (!campusNodes) return;

            const allNodes = campusNodes.exportNodes();
            const nodeListDiv = document.getElementById('nodeList');
            
            let html = '';
            allNodes.forEach(node => {
                html += `
                    <div class="node-item">
                        <span class="node-type">${node.type}</span> - ${node.name}
                        <div class="node-coords">[${node.coords[0].toFixed(6)}, ${node.coords[1].toFixed(6)}]</div>
                    </div>
                `;
            });

            nodeListDiv.innerHTML = html;
        }

        // Inicializar cuando el DOM est√© listo
        $(document).ready(function() {
            log('üöÄ Iniciando tests del PASO 2...');
            initTestMap();
            log('üí° Haz clic en los botones de arriba para probar cada funcionalidad');
        });
    </script>
</body>
</html>
