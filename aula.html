<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ubica tu Aula</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="vendor/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="vendor/owlcarousel/owl.carousel.min.css">
    <link rel="stylesheet" href="vendor/select2/select2.min.css">
    <link rel="stylesheet" href="vendor/lightcase/lightcase.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.min.css">
</head>

<body data-spy="scroll" data-target="#navbar" class="static-layout">

    <nav id="header-navbar" class="navbar navbar-expand-lg py-4">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center text-white" href="/">
                <img src="img/navbar.svg" alt="UBICATEC logo" style="height: 25px;" />
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-nav-header"
                aria-controls="navbar-nav-header" aria-expanded="false" aria-label="Toggle navigation">
                <span class="lnr lnr-menu"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbar-nav-header">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="aula.html">Ubica tu Edificio</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="sitiosDropdown" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">Accesos Estudiantes</a>
                        <div class="dropdown-menu" aria-labelledby="sitiosDropdown">
                            <a class="dropdown-item" href="https://puebla.ambar.tecnm.mx/">Ambar</a>
                            <a class="dropdown-item" href="https://idiomastecpueblacle.blogspot.com/">Coordinaci√≥n de Lenguas Extranjeras</a>
                            <a class="dropdown-item" href="https://evadoc.puebla.tecnm.mx/">Sitio Evaluaci√≥n Docente</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="mapa-campus-section text-center">
        <div class="container text-center">
            <h2 class="titulo-mapa">Mapa del Campus</h2>
        </div>
    </section>

    <section id="mapa" class="py-5 bg-light">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-12 text-center">
                    <h2 class="mb-4">Ubica tu Edificio</h2>
                    <p class="text-muted">Instrucciones: usa el buscador o los filtros para localizar el edificio que deseas consultar</p>
                    <input type="text" id="searchInput" class="form-control" placeholder="Ingresa el n√∫mero de edificio" />
                    <div class="filter-container">
                        <button class="filter-button" data-filter="otros">Otros</button>
                        <button class="filter-button" data-filter="administrativo">Administrativo</button>
                        <button class="filter-button" data-filter="aula">Aulas</button>
                        <button class="filter-button" data-filter="laboratorio">Laboratorios</button>
                        <button class="filter-button" data-filter="ba√±o">Ba√±os</button>
                        <button class="filter-button" data-filter="acceso">Accesos</button>
                        <button class="filter-button" id="rutasAccesiblesBtn" style="background-color: #28a745; color: white; border: 1px solid #28a745;">‚ôø Rutas Accesibles</button>
                    </div>
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </section>

    <footer class="text-center py-4 bg-dark text-white">
        <p>&copy; 2025 UBICATEC. Todos los derechos reservados.</p>
    </footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="vendor/bootstrap/bootstrap.min.js"></script>
    <script src="vendor/owlcarousel/owl.carousel.min.js"></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    
    <!-- Librer√≠as faltantes para app.min.js -->
    <script src="vendor/stellar/jquery.stellar.js"></script>
    <script src="vendor/select2/select2.min.js"></script>
    <script src="vendor/isotope/isotope.min.js"></script>
    <script src="vendor/lightcase/lightcase.js"></script>
    <script src="vendor/waypoints/waypoint.min.js"></script>
    <script src="vendor/countto/jquery.countto.js"></script>
    
    <!-- Inicializar el mapa primero -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="js/mapa.js"></script>
    
    <!-- Cargar app.min.js despu√©s de que el mapa est√© listo -->
    <script>
        $(document).ready(function() {
            // Esperar a que el mapa est√© inicializado antes de cargar app.min.js
            if (typeof window.map !== 'undefined' && window.map) {
                // Cargar app.min.js din√°micamente
                var script = document.createElement('script');
                script.src = 'js/app.min.js';
                script.onload = function() {
                    console.log('‚úÖ app.min.js cargado correctamente');
                };
                script.onerror = function() {
                    console.warn('‚ö†Ô∏è Error cargando app.min.js');
                };
                document.head.appendChild(script);
            } else {
                // Si el mapa no est√° listo, reintentar
                setTimeout(function() {
                    location.reload();
                }, 1000);
            }
        });
    </script>
    
    <!-- Scripts del sistema de rutas accesibles - NUEVA ARQUITECTURA -->
    <script src="js/campus-graph.js"></script>
    <script src="js/route-calculator.js"></script>
    <script src="js/route-visualizer.js"></script>
    <script src="js/navigation-system.js"></script>
    <script src="js/test-navigation.js"></script>
    <script src="js/visual-indicators.js"></script>
    <script src="js/accessibility-modal.js"></script>
    
    <!-- Integraci√≥n del bot√≥n de rutas accesibles -->
    <script>
        // Variables globales para el sistema UNIFICADO
        let accessibilityModal = null;
        let routeVisualizer = null;
        let visualIndicators = null;
        let grafo = null;
        let dijkstraCalculator = null;
        
        // Funciones globales para el c√°lculo de rutas - SISTEMA UNIFICADO
        function handleRouteCalculation(routeOptions) {
            console.log('üõ£Ô∏è Calculando ruta:', routeOptions);
            
            try {
                if (!grafo || !dijkstraCalculator) {
                    alert('‚ùå Sistema no inicializado. Intenta recargar la p√°gina.');
                    return;
                }
                
                // Verificar que los nodos existan
                const startNode = grafo.getNode(routeOptions.start);
                const endNode = grafo.getNode(routeOptions.end);
                
                if (!startNode) {
                    throw new Error(`Edificio de inicio no encontrado: ${routeOptions.start}`);
                }
                
                if (!endNode) {
                    throw new Error(`Edificio de destino no encontrado: ${routeOptions.end}`);
                }
                
                console.log('‚úÖ Edificios encontrados:', { 
                    start: startNode.name, 
                    end: endNode.name 
                });
                
                // Calcular ruta usando el sistema unificado
                const route = dijkstraCalculator.calculateRoute(
                    routeOptions.start,
                    routeOptions.end,
                    routeOptions.accessibilityType
                );
                
                if (route && route.path.length > 0) {
                    // Inicializar RouteVisualizer si no est√° disponible
                    if (!routeVisualizer) {
                        console.log('üîÑ Inicializando RouteVisualizer...');
                        
                        // Contador de reintentos para evitar bucle infinito
                        let retryCount = 0;
                        const maxRetries = 10; // M√°ximo 10 reintentos (5 segundos)
                        
                        // Funci√≥n para intentar inicializar el visualizador
                        const tryInitializeVisualizer = () => {
                            retryCount++;
                            
                            // Verificar que el mapa est√© disponible
                            if (!window.map || typeof window.map.addLayer !== 'function') {
                                if (retryCount >= maxRetries) {
                                    console.error('‚ùå Mapa no disponible despu√©s de 10 reintentos. Abortando...');
                                    alert('‚ùå Error: El mapa no est√° disponible. Recarga la p√°gina e intenta de nuevo.');
                                    return;
                                }
                                console.warn(`‚ö†Ô∏è Mapa a√∫n no disponible, reintentando en 500ms... (${retryCount}/${maxRetries})`);
                                setTimeout(tryInitializeVisualizer, 500);
                                return;
                            }
                            
                            try {
                                routeVisualizer = new RouteVisualizer();
                                const initResult = routeVisualizer.init(window.map);
                                console.log('‚úÖ RouteVisualizer inicializado correctamente:', initResult);
                                
                                // Verificar que el mapa se guard√≥ correctamente
                                if (!routeVisualizer.map) {
                                    console.error('‚ùå El mapa no se guard√≥ correctamente en el visualizador');
                                    alert('‚ùå Error: El visualizador no pudo conectar con el mapa');
                                    return;
                                }
                                
                                // Ahora que el visualizador est√° listo, visualizar la ruta
                                routeVisualizer.visualizeRoute(route, routeOptions.accessibilityType);
                                
                            } catch (error) {
                                console.error('‚ùå Error inicializando RouteVisualizer:', error);
                                alert('‚ùå Error inicializando el visualizador de rutas');
                                return;
                            }
                        };
                        
                        // Intentar inicializar inmediatamente o con retry
                        tryInitializeVisualizer();
                        return; // Salir aqu√≠ para evitar la visualizaci√≥n duplicada
                    }
                    
                    // Visualizar ruta en el mapa
                    routeVisualizer.visualizeRoute(route, routeOptions.accessibilityType);
                    
                    // Mostrar informaci√≥n de la ruta en el modal
                    accessibilityModal.showRouteInfo(route);
                    
                    console.log('‚úÖ Ruta calculada y visualizada correctamente');
                    
                    // Mostrar mensaje de √©xito
                    setTimeout(() => {
                        alert(`‚úÖ Ruta calculada exitosamente!\n\nDistancia: ${route.totalDistance.toFixed(1)} metros\nTiempo estimado: ${route.estimatedTime.toFixed(1)} minutos\n\nLa ruta se ha marcado en el mapa.`);
                    }, 500);
                    
                } else {
                    alert('‚ùå No se pudo calcular una ruta accesible entre los puntos seleccionados.');
                }
                
            } catch (error) {
                console.error('‚ùå Error calculando ruta:', error);
                alert('‚ùå Error calculando la ruta: ' + error.message);
            }
        }
            
            function handleAccessibilityChange(accessibilityType) {
                console.log('üéØ Tipo de accesibilidad cambiado:', accessibilityType);
                
                // Aqu√≠ se pueden hacer ajustes adicionales seg√∫n el tipo de accesibilidad
                // Por ejemplo, cambiar colores del mapa, mostrar informaci√≥n espec√≠fica, etc.
        }
        
        
        // Inicializar el sistema unificado
        function initializeUnifiedSystem() {
            console.log('üöÄ Inicializando sistema unificado...');
            
            try {
                // Inicializar grafo est√°tico del campus
                grafo = new CampusGraph();
                console.log(`‚úÖ Grafo inicializado: ${grafo.nodes.size} nodos, ${grafo.getTotalConnections()} conexiones`);
                
                // Exponer el grafo globalmente para el RouteVisualizer
                window.grafo = grafo;
                console.log('üåê Grafo expuesto globalmente como window.grafo');
                
                // Inicializar calculador de rutas
                dijkstraCalculator = new RouteCalculator(grafo);
                console.log('‚úÖ Calculador de rutas inicializado');
                
                // Inicializar modal de accesibilidad
                accessibilityModal = new AccessibilityModal();
                accessibilityModal.init();
                
                // Configurar sistema de nodos en el modal
                accessibilityModal.setNodesSystem(grafo);
                
                // Cargar edificios en el modal
                const buildings = Array.from(grafo.nodes.values()).filter(node => node.type === 'building');
                accessibilityModal.loadBuildings(buildings);
                
                // Configurar callbacks
                accessibilityModal.setOnRouteCalculate(handleRouteCalculation);
                accessibilityModal.setOnAccessibilityChange(handleAccessibilityChange);
                
                console.log('‚úÖ Sistema unificado inicializado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando sistema unificado:', error);
                alert('Error inicializando el sistema: ' + error.message);
            }
        }
        
        // Esperar a que el mapa est√© completamente inicializado
        function waitForMapAndInitialize() {
            console.log('üîç Esperando que el mapa est√© listo...');
            
            // Verificar si el mapa est√° disponible
            if (window.map && typeof window.map.addLayer === 'function') {
                console.log('‚úÖ Mapa detectado, inicializando sistema...');
                initializeUnifiedSystem();
            } else {
                console.log('‚è≥ Mapa no listo, reintentando en 1 segundo...');
                setTimeout(waitForMapAndInitialize, 1000);
            }
        }
        
        // Inicializar cuando el DOM est√© listo
        $(document).ready(function() {
            console.log('üöÄ DOM listo, esperando mapa...');
            
            // Esperar un poco m√°s para que mapa.js se ejecute
            setTimeout(waitForMapAndInitialize, 1000);
        });
        
        $(document).ready(function() {
            // Configurar el bot√≥n de rutas accesibles
            $('#rutasAccesiblesBtn').on('click', function() {
                console.log('üîç Bot√≥n de rutas accesibles presionado');
                
                // Verificar si el sistema est√° listo
                if (grafo && dijkstraCalculator && accessibilityModal) {
                    // Mostrar el modal
                    accessibilityModal.show();
                    console.log('‚úÖ Modal de accesibilidad mostrado');
                } else {
                    console.warn('‚ö†Ô∏è Sistema de accesibilidad a√∫n no est√° listo');
                    alert('‚è≥ Sistema de rutas accesibles a√∫n se est√° cargando. Espera unos segundos e intenta de nuevo.');
                }
            });
            
            // Configurar b√∫squeda para abrir modal autom√°ticamente
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    const searchTerm = $(this).val().trim();
                    if (searchTerm && grafo && accessibilityModal) {
                        // Buscar el edificio en el grafo unificado
                        const buildings = Array.from(grafo.nodes.values()).filter(node => node.type === 'building');
                        const foundBuilding = buildings.find(b => 
                            b.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            b.id.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                        
                        if (foundBuilding) {
                            // Abrir modal y preseleccionar el edificio
                            accessibilityModal.show();
                            
                            // Preseleccionar el edificio encontrado
                            setTimeout(() => {
                                $('#endBuilding').val(foundBuilding.id).trigger('change');
                            }, 500);
                            
                            console.log('‚úÖ Edificio encontrado y preseleccionado:', foundBuilding.name);
                        } else {
                            alert('‚ùå No se encontr√≥ el edificio: ' + searchTerm);
                        }
                    }
                }
            });
        });
    </script>

</body>

</html>