<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Validaci√≥n de Coordenadas PASO 5</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #map { height: 400px; width: 100%; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0; }
        .stat-card { background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center; }
        .discrepancy-list { max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; }
        .discrepancy-item { padding: 5px; border-bottom: 1px solid #ddd; font-size: 12px; }
        .discrepancy-high { border-left: 4px solid #dc3545; }
        .discrepancy-medium { border-left: 4px solid #ffc107; }
        .discrepancy-low { border-left: 4px solid #28a745; }
    </style>
</head>
<body>
    <h1>üß™ Test del PASO 5 - Validaci√≥n de Coordenadas</h1>
    
    <div class="test-section info">
        <h3>üìã Informaci√≥n del Test</h3>
        <p>Este test verifica que el PASO 5 (validaci√≥n de coordenadas) funcione correctamente.</p>
        <p><strong>Archivo creado:</strong> js/coordinate-validator.js</p>
        <p><strong>Funcionalidades:</strong> Validaci√≥n de coordenadas, ajustes autom√°ticos, reportes de precisi√≥n</p>
    </div>

    <div class="test-section">
        <h3>üó∫Ô∏è Mapa de Validaci√≥n</h3>
        <p>Mapa mostrando edificios y sus coordenadas validadas:</p>
        <div id="map"></div>
    </div>

    <div class="test-section">
        <h3>üîß Controles de Prueba</h3>
        <button onclick="testInitialization()">1. Probar Inicializaci√≥n</button>
        <button onclick="testValidation()">2. Validar Coordenadas</button>
        <button onclick="testAccuracy()">3. Verificar Precisi√≥n</button>
        <button onclick="testAdjustments()">4. Ajustar Coordenadas</button>
        <button onclick="testReport()">5. Generar Reporte</button>
        <button onclick="exportReport()">6. Exportar Reporte</button>
        <button onclick="clearLog()">üßπ Limpiar Log</button>
    </div>

    <div class="test-section">
        <h3>üìä Estad√≠sticas de Validaci√≥n</h3>
        <div id="stats" class="stats"></div>
    </div>

    <div class="test-section">
        <h3>üìù Log de Resultados</h3>
        <div id="log" class="log">Esperando pruebas...<br></div>
    </div>

    <div class="test-section">
        <h3>‚ö†Ô∏è Discrepancias Encontradas</h3>
        <div id="discrepancyList" class="discrepancy-list">Cargando discrepancias...</div>
    </div>

    <!-- Dependencias necesarias -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- Nuestros sistemas -->
    <script src="js/campus-nodes.js"></script>
    <script src="js/coordinate-validator.js"></script>

    <script>
        let map;
        let campusNodes;
        let coordinateValidator;
        let nodeMarkers = [];

        // Inicializar mapa de prueba
        function initTestMap() {
            map = L.map('map').setView([19.0698, -98.1688], 18);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            log('‚úÖ Mapa de prueba inicializado');
        }

        // Funci√≥n de logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'Log limpiado...<br>';
        }

        // Test 1: Inicializaci√≥n
        function testInitialization() {
            log('üß™ Iniciando test de inicializaci√≥n...');
            
            try {
                if (typeof CampusNodes === 'undefined') {
                    throw new Error('Clase CampusNodes no encontrada');
                }
                
                if (typeof CoordinateValidator === 'undefined') {
                    throw new Error('Clase CoordinateValidator no encontrada');
                }
                
                log('‚úÖ Clases encontradas');
                
                // Crear instancias
                campusNodes = new CampusNodes();
                coordinateValidator = new CoordinateValidator();
                
                // Conectar los sistemas
                coordinateValidator.setCampusNodes(campusNodes);
                
                log('‚úÖ Sistemas conectados correctamente');
                
                // Mostrar nodos en el mapa
                displayNodesOnMap();
                
                log('‚úÖ Test de inicializaci√≥n completado', 'success');
                
            } catch (error) {
                log(`‚ùå Error en inicializaci√≥n: ${error.message}`, 'error');
            }
        }

        // Test 2: Validaci√≥n de coordenadas
        function testValidation() {
            log('üß™ Iniciando validaci√≥n de coordenadas...');
            
            if (!coordinateValidator) {
                log('‚ùå CoordinateValidator no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            const results = coordinateValidator.validateAllCoordinates();
            
            if (results) {
                log(`üìä Resultados de validaci√≥n:`);
                log(`   - Total edificios: ${results.total}`);
                log(`   - Coordenadas v√°lidas: ${results.valid}`);
                log(`   - Coordenadas inv√°lidas: ${results.invalid}`);
                log(`   - Tasa de precisi√≥n: ${((results.valid / results.total) * 100).toFixed(2)}%`);
                
                // Mostrar estad√≠sticas
                displayValidationStats(results);
                
                // Mostrar discrepancias
                displayDiscrepancies(results.discrepancies);
                
                log('‚úÖ Validaci√≥n completada', 'success');
            } else {
                log('‚ùå Error en la validaci√≥n', 'error');
            }
        }

        // Test 3: Verificar precisi√≥n
        function testAccuracy() {
            log('üß™ Verificando precisi√≥n de ubicaciones...');
            
            if (!coordinateValidator) {
                log('‚ùå CoordinateValidator no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            const accuracyReport = coordinateValidator.checkLocationAccuracy();
            
            if (accuracyReport) {
                log(`üéØ Reporte de precisi√≥n:`);
                log(`   - Total edificios: ${accuracyReport.total}`);
                log(`   - Alta precisi√≥n (< 5m): ${accuracyReport.highPrecision}`);
                log(`   - Precisi√≥n media (5-20m): ${accuracyReport.mediumPrecision}`);
                log(`   - Baja precisi√≥n (> 20m): ${accuracyReport.lowPrecision}`);
                
                if (accuracyReport.issues.length > 0) {
                    log(`‚ö†Ô∏è Problemas encontrados: ${accuracyReport.issues.length}`);
                    accuracyReport.issues.forEach(issue => {
                        log(`   - ${issue.name}: ${issue.distance.toFixed(2)}m (${issue.severity})`);
                    });
                }
                
                log('‚úÖ Verificaci√≥n de precisi√≥n completada', 'success');
            } else {
                log('‚ùå Error en la verificaci√≥n de precisi√≥n', 'error');
            }
        }

        // Test 4: Ajustar coordenadas
        function testAdjustments() {
            log('üß™ Ajustando coordenadas...');
            
            if (!coordinateValidator) {
                log('‚ùå CoordinateValidator no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            const statsBefore = coordinateValidator.getValidationStats();
            log(`üìä Antes del ajuste: ${statsBefore.valid}/${statsBefore.total} v√°lidas`);
            
            coordinateValidator.adjustCoordinates();
            
            const statsAfter = coordinateValidator.getValidationStats();
            log(`üìä Despu√©s del ajuste: ${statsAfter.valid}/${statsAfter.total} v√°lidas`);
            log(`üîß Coordenadas ajustadas: ${statsAfter.adjusted}`);
            
            // Actualizar visualizaci√≥n
            displayNodesOnMap();
            
            log('‚úÖ Ajuste de coordenadas completado', 'success');
        }

        // Test 5: Generar reporte
        function testReport() {
            log('üß™ Generando reporte de validaci√≥n...');
            
            if (!coordinateValidator) {
                log('‚ùå CoordinateValidator no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            const report = coordinateValidator.generateValidationReport();
            
            log(`üìã Reporte generado:`);
            log(`   - Timestamp: ${report.timestamp}`);
            log(`   - Total edificios: ${report.summary.total}`);
            log(`   - V√°lidos: ${report.summary.valid}`);
            log(`   - Inv√°lidos: ${report.summary.invalid}`);
            log(`   - Ajustados: ${report.summary.adjusted}`);
            
            if (report.recommendations.length > 0) {
                log(`üí° Recomendaciones: ${report.recommendations.length}`);
                report.recommendations.forEach(rec => {
                    log(`   - [${rec.priority}] ${rec.message}`);
                });
            }
            
            log('‚úÖ Reporte generado correctamente', 'success');
        }

        // Test 6: Exportar reporte
        function exportReport() {
            log('üß™ Exportando reporte...');
            
            if (!coordinateValidator) {
                log('‚ùå CoordinateValidator no inicializado. Ejecuta primero el test de inicializaci√≥n.', 'error');
                return;
            }

            try {
                coordinateValidator.exportReport();
                log('‚úÖ Reporte exportado correctamente', 'success');
            } catch (error) {
                log(`‚ùå Error al exportar reporte: ${error.message}`, 'error');
            }
        }

        // Mostrar estad√≠sticas de validaci√≥n
        function displayValidationStats(results) {
            const statsDiv = document.getElementById('stats');
            const accuracyRate = ((results.valid / results.total) * 100).toFixed(2);
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <h4>Total</h4>
                    <p>${results.total}</p>
                </div>
                <div class="stat-card">
                    <h4>V√°lidas</h4>
                    <p style="color: #28a745;">${results.valid}</p>
                </div>
                <div class="stat-card">
                    <h4>Inv√°lidas</h4>
                    <p style="color: #dc3545;">${results.invalid}</p>
                </div>
                <div class="stat-card">
                    <h4>Precisi√≥n</h4>
                    <p>${accuracyRate}%</p>
                </div>
                <div class="stat-card">
                    <h4>Ajustadas</h4>
                    <p>${results.adjusted}</p>
                </div>
                <div class="stat-card">
                    <h4>Discrepancias</h4>
                    <p>${results.discrepancies.length}</p>
                </div>
            `;
        }

        // Mostrar discrepancias
        function displayDiscrepancies(discrepancies) {
            const discrepancyDiv = document.getElementById('discrepancyList');
            
            if (discrepancies.length === 0) {
                discrepancyDiv.innerHTML = '<div class="discrepancy-item">‚úÖ No se encontraron discrepancias</div>';
                return;
            }
            
            let html = '';
            discrepancies.forEach(discrepancy => {
                const severity = discrepancy.distance > 50 ? 'high' : discrepancy.distance > 20 ? 'medium' : 'low';
                const className = `discrepancy-item discrepancy-${severity}`;
                
                html += `
                    <div class="${className}">
                        <strong>${discrepancy.name}</strong><br>
                        ${discrepancy.type === 'coordinate_mismatch' ? 
                            `Distancia: ${discrepancy.distance.toFixed(2)}m` : 
                            'Edificio no encontrado en datos originales'
                        }
                    </div>
                `;
            });
            
            discrepancyDiv.innerHTML = html;
        }

        // Mostrar nodos en el mapa
        function displayNodesOnMap() {
            if (!campusNodes) return;

            // Limpiar marcadores existentes
            nodeMarkers.forEach(marker => map.removeLayer(marker));
            nodeMarkers = [];

            const buildings = campusNodes.findNodesByType('building');
            
            buildings.forEach(building => {
                const marker = L.circleMarker(building.coords, {
                    radius: 5,
                    fillColor: 'blue',
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindPopup(`
                    <strong>${building.name}</strong><br>
                    Coordenadas: [${building.coords[0].toFixed(6)}, ${building.coords[1].toFixed(6)}]<br>
                    Tipo: ${building.buildingType}
                `);

                nodeMarkers.push(marker);
            });

            log(`üó∫Ô∏è ${buildings.length} edificios mostrados en el mapa`);
        }

        // Inicializar cuando el DOM est√© listo
        $(document).ready(function() {
            log('üöÄ Iniciando tests del PASO 5...');
            initTestMap();
            log('üí° Haz clic en los botones de arriba para probar cada funcionalidad');
        });
    </script>
</body>
</html>
